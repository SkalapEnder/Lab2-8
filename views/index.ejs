<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body{
            background-color: #dbdbdb;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fs-3">
    <div class="collapse navbar-collapse justify-content-around">
        <a class="navbar-brand fs-3 p-2 fw-bold" href="/">Lab Work 2 - Week 8</a>
    </div>
</nav>

<div class="container-fluid text-center mt-4 p-4 w-50 shadow bg-white rounded">
    <h1>Welcome to Bookstore!</h1>
    <p class="fs-4">Welcome to Bookstore. You can create new book, retrieve info about books, update and delete them.</p>
    <form action="/create" method="GET">
        <button class="btn btn-success">Create New Book</button>
    </form>
</div>

<div class="container-fluid text-center my-4 p-4 w-75 shadow bg-white rounded">
    <% if (error) { %>
        <div class="alert alert-danger" role="alert">
            <%= error %>
        </div>
    <% } %>

    <!-- Filter and Sort Options -->
    <div class="container bg-white rounded my-3 p-1">
        <h2>Filters</h2>
        <hr>
        <div class="container-fluid mb-4 justify-content-center">
            <form action="/api/books" method="GET" class="d-flex justify-content-center align-items-center mx-auto w-50 mb-2">
                <label for="id" class="w-50 me-2">Search Book by ID: </label>
                <input type="number" id="id" placeholder="Search by Book ID (e.g., 1)" name="id" class="form-control me-2">
                <button type="submit" class="btn btn-secondary fs-5">Search</button>
            </form>
        </div>
        <hr>

        <form action="/api/books/filter" method="POST" class="mb-2">
            <div class="d-flex justify-content-center align-items-center mx-auto mb-2">
                <label for="search" class="w-25 me-2">Search Book by Filters: </label>
                <input type="text" id="search" placeholder="Search by title, author, or genre" name="search" class="form-control me-2">
            </div>



            <select id="genreFilter" name="genre" class="form-select d-inline-block w-auto">
                <option value="none">All Genres</option>
                <% genres.forEach(genre => { %>
                    <option value="<%= genre %>"><%= genre %></option>
                <% }); %>
            </select>
            <select id="authorFilter" name="author" class="form-select d-inline-block w-auto">
                <option value="none">All Authors</option>
                <% authors.forEach(author => { %>
                    <option value="<%= author %>"><%= author %></option>
                <% }); %>
            </select>
            <select id="yearFilter" name="year" class="form-select d-inline-block w-auto">
                <option value="none">All Years</option>
                <% years.forEach(year => { %>
                    <option value="<%= year %>"><%= year %></option>
                <% }); %>
            </select>
            <select id="sortBy" name="sortBy" class="form-select d-inline-block w-auto">
                <option value="title">Sort by Title</option>
                <option value="author">Sort by Author</option>
                <option value="year">Sort by Year</option>
                <option value="price">Sort by Price</option>
            </select>

            <button type="submit" class="btn btn-secondary fs-5">Search</button>
        </form>
    </div>

    <!-- Table -->
    <h2>Books:</h2>
        <hr>
    <table class="table table-striped">
        <thead>
        <tr>
            <th style="width: 40px;">Book ID</th>
            <th style="width: 100px;">Title</th>
            <th style="width: 150px;">Author(s)</th>
            <th style="width: 100px;">Genre(s)</th>
            <th style="width: 50px;">Year</th>
            <th style="width: 50px;">Quantity</th>
            <th style="width: 50px;">Price</th>
            <th style="width: 140px;">Actions</th>
        </tr>
        </thead>
        <tbody>
        <% if (books.length === 0) { %>
            <tr>
                <td colspan="8" style="text-align: center;">No books available.</td>
            </tr>
        <% } else { %>
            <% books.forEach(function(book) { %>
                <tr style="height: 50px;" data-book-id="<%= book.book_id %>">
                    <td><%= book.book_id %></td>
                    <td><input type="text" class="book-title" value="<%= book.title %>"></td>
                    <td><input type="text" class="book-author" value="<%= book.authors.join(', ') %>"></td>
                    <td><input type="text" class="book-genre" value="<%= book.genres.join(', ') %>"></td>
                    <td><input type="number" class="book-year" style="width: 80px;" value="<%= book.year %>"></td>
                    <td><input type="number" class="book-quantity" style="width: 80px;" value="<%= book.quantity %>"></td>
                    <td><input type="number" class="book-price" style="width: 80px;" value="<%= book.price %>"></td>
                    <td>
                        <div>
                            <button class="btn btn-outline-secondary mb-3" onclick="updateBook('<%= book.book_id %>')">Update Book</button>
                            <button class="btn btn-outline-danger mb-3" onclick="deleteBook('<%= book.book_id %>')">Delete Book</button>
                        </div>
                    </td>
                </tr>
            <% }); %>
        <% } %>
        </tbody>
    </table>

    <nav>
        <ul class="pagination justify-content-center">
            <% for (let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                </li>
            <% } %>
        </ul>
    </nav>
</div>

<div class="py-2 text-center fs-5 fixed-bottom text-white bg-dark">
    <h4>Alisher Berik | IT-2308</h4>
</div>

<script>
    async function updateBook(bookId) {
        try {
            const bookRow = document.querySelector(`[data-book-id="${bookId}"]`);

            const title = bookRow.querySelector('.book-title').value;
            const author = bookRow.querySelector('.book-author').value.split(',').map(a => a.trim());
            const genre = bookRow.querySelector('.book-genre').value.split(',').map(g => g.trim());
            const year = parseInt(bookRow.querySelector('.book-year').value);
            const quantity = parseInt(bookRow.querySelector('.book-quantity').value);
            const price = parseFloat(bookRow.querySelector('.book-price').value);

            const response = await fetch(`/api/books/${bookId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, author, genre, year, quantity, price }),
            });

            if (response.ok) {
                alert('Book was updated');
                window.location.reload();
            } else {
                console.error('Failed to update book');
                alert('Error updating book: Response is NOT Ok');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error updating book: ' + error);
        }
    }

    async function deleteBook(bookId) {
        try {
            const response = await fetch(`/api/books/${bookId}`, { method: 'DELETE' });

            if (response.ok) {
                alert('Book Was Deleted');
                window.location.reload();
            } else {
                alert('Error deleting book');
            }
        } catch (error) {
            console.error(error);
            alert('Error deleting book');
        }
    }
</script>
</body>
</html>
