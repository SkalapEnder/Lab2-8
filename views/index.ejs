<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body{
            background-color: #dbdbdb;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fs-3">
    <div class="collapse navbar-collapse justify-content-around">
        <a class="navbar-brand fs-3 p-2 fw-bold" href="/">Lab Work 2 - Week 8</a>
    </div>
</nav>

<div class="container-fluid text-center mt-4 p-4 w-50 shadow bg-white rounded">
    <h1>Welcome to Bookstore!</h1>
    <p class="fs-4">Welcome to Bookstore. You can create new book, retrieve info about books, update and delete them.</p>
    <button class="btn btn-success">Create New Book</button>
</div>

<div class="container-fluid text-center my-4 p-4 w-75 shadow bg-white rounded">
    <% if (error) { %>
        <div class="alert alert-danger" role="alert">
            <%= error %>
        </div>
    <% } %>

    <!-- Filter and Sort Options -->
    <div class="container bg-white rounde my-3 p-1">

            <div class="mb-4 d-flex  justify-content-around">
                <input type="number" id="searchInput" placeholder="Search by Book ID (e.g., 1)" class="form-control w-25 me-2">
                <input type="text" id="searchInput" placeholder="Search by title, author, or genre" class="form-control">
                <button class="btn btn-primary ms-2 mt-2 fs-5" onclick="applyFilters()">Search</button>
            </div>


            <div class="mb-4">
                <select id="genreFilter" class="form-select d-inline-block w-auto">
                    <option value="">All Genres</option>
                    <% genres.forEach(genre => { %>
                        <option value="<%= genre %>"><%= genre %></option>
                    <% }); %>
                </select>
                <select id="authorFilter" class="form-select d-inline-block w-auto">
                    <option value="">All Authors</option>
                    <% authors.forEach(author => { %>
                        <option value="<%= author %>"><%= author %></option>
                    <% }); %>
                </select>
                <select id="yearFilter" class="form-select d-inline-block w-auto">
                    <option value="">All Years</option>
                    <% years.forEach(year => { %>
                        <option value="<%= year %>"><%= year %></option>
                    <% }); %>
                </select>
                <select id="sortBy" class="form-select d-inline-block w-auto">
                    <option value="title">Sort by Title</option>
                    <option value="author">Sort by Author</option>
                    <option value="year">Sort by Year</option>
                    <option value="price">Sort by Price</option>
                </select>
            </div>
    </div>

    <!-- Table -->
    <h2>Books:</h2>
    <table class="table table-striped">
        <thead>
        <tr>
            <th style="width: 40px;">Book ID</th>
            <th style="width: 100px;">Title</th>
            <th style="width: 150px;">Author(s)</th>
            <th style="width: 100px;">Genre(s)</th>
            <th style="width: 50px;">Year</th>
            <th style="width: 50px;">Quantity</th>
            <th style="width: 50px;">Price</th>
            <th style="width: 140px;">Actions</th>
        </tr>
        </thead>
        <tbody>
        <% books.forEach(function(book) { %>
            <tr style="height: 50px;" data-book-id="<%= book.book_id %>">
                <td><%= book.book_id %></td>
                <td><input type="text" class="book-title" value="<%= book.title %>"></td>
                <td><input type="text" class="book-author" value="<%= book.author.join(', ') %>"></td>
                <td><input type="text" class="book-genre" value="<%= book.genre.join(', ') %>"></td>
                <td><input type="number" class="book-year" value="<%= book.year %>"></td>
                <td><input type="number" class="book-quantity" value="<%= book.quantity %>"></td>
                <td><input type="number" class="book-price" value="<%= book.price %>"></td>
                <td>
                    <div>
                        <button class="btn btn-outline-secondary mb-3" onclick="updateBook('<%= book.book_id %>')">Update Book</button>
                        <button class="btn btn-outline-danger mb-3" onclick="deleteBook('<%= book.book_id %>')">Delete Book</button>
                    </div>
                </td>
            </tr>
        <% }); %>
        </tbody>
    </table>

    <nav>
        <ul class="pagination justify-content-center">
            <% for (let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                </li>
            <% } %>
        </ul>
    </nav>
</div>

<div class="py-2 text-center fs-5 fixed-bottom text-white bg-dark">
    <h4>Alisher Berik | IT-2308</h4>
</div>

<script>
    function applyFilters() {
        const search = document.getElementById('searchInput').value;
        const genre = document.getElementById('genreFilter').value;
        const author = document.getElementById('authorFilter').value;
        const year = document.getElementById('yearFilter').value;
        const sortBy = document.getElementById('sortBy').value;

        let url = `/?search=${search}&genre=${genre}&author=${author}&year=${year}&sortBy=${sortBy}`;
        window.location.href = url;
    }

    async function updateBook(bookId) {
        try {
            const bookRow = document.querySelector(`[data-book-id="${bookId}"]`);

            const title = bookRow.querySelector('.book-title').value;
            const author = bookRow.querySelector('.book-author').value.split(',').map(a => a.trim());
            const genre = bookRow.querySelector('.book-genre').value.split(',').map(g => g.trim());
            const year = parseInt(bookRow.querySelector('.book-year').value);
            const quantity = parseInt(bookRow.querySelector('.book-quantity').value);
            const price = parseFloat(bookRow.querySelector('.book-price').value);

            const response = await fetch(`/books/put/${bookId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, author, genre, year, quantity, price }),
            });

            if (response.ok) {
                alert('Book was updated');
                window.location.reload();
            } else {
                console.error('Failed to update book');
                alert('Error updating book: Response is NOT Ok');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error updating book: ' + error);
        }
    }

    async function deleteBook(bookId) {
        try {
            const response = await fetch(`/books/delete/${bookId}`, { method: 'DELETE' });

            if (response.ok) {
                alert('Book Was Deleted');
                window.location.reload();
            } else {
                alert('Error deleting book');
            }
        } catch (error) {
            console.error(error);
            alert('Error deleting book');
        }
    }
</script>
</body>
</html>
